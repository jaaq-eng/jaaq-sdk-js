<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JAAQ Embed Player</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #000;
      }

      #player-container {
        width: 100%;
        height: 100%;
      }

      .error-container {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        background: #1a1a1a;
        color: #fff;
        padding: 20px;
      }

      .error-content {
        text-align: center;
        max-width: 400px;
      }

      .error-content h1 {
        font-size: 18px;
        margin-bottom: 12px;
        color: #ff6b6b;
      }

      .error-content p {
        font-size: 14px;
        color: #ccc;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div id="player-container"></div>

    <script>
      function showError(message) {
        console.error('[Embed] Showing error:', message);
        const container = document.getElementById('player-container');
        if (!container) {
          console.error('[Embed] Container not found!');
          return;
        }
        container.innerHTML = `
          <div class="error-container">
            <div class="error-content">
              <h1>⚠️ Player Error</h1>
              <p>${message}</p>
            </div>
          </div>
        `;
      }

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const config = {};

        const apiKey = params.get('apiKey');
        const clientId = params.get('clientId');
        const videoId = params.get('videoId');

        if (!apiKey || !clientId || !videoId) {
          const missing = [];
          if (!apiKey) missing.push('apiKey');
          if (!clientId) missing.push('clientId');
          if (!videoId) missing.push('videoId');
          throw new Error(`Missing required parameters: ${missing.join(', ')}`);
        }

        config.apiKey = apiKey;
        config.clientId = clientId;
        config.videoId = videoId;

        const autoplay = params.get('autoplay');
        if (autoplay !== null) {
          config.autoplay = autoplay === 'true' || autoplay === '1';
        }

        const width = params.get('width');
        if (width) {
          config.width = width;
        }

        const height = params.get('height');
        if (height) {
          config.height = height;
        }

        const baseUrl = params.get('baseUrl');
        if (baseUrl) {
          config.baseUrl = baseUrl;
        }

        const controls = params.get('controls');
        if (controls !== null) {
          config.controls = controls === 'true' || controls === '1';
        }

        const showLogo = params.get('showLogo');
        if (showLogo !== null) {
          config.showLogo = showLogo === 'true' || showLogo === '1';
        }

        const showTitle = params.get('showTitle');
        if (showTitle !== null) {
          config.showTitle = showTitle === 'true' || showTitle === '1';
        }

        const showAuthor = params.get('showAuthor');
        if (showAuthor !== null) {
          config.showAuthor = showAuthor === 'true' || showAuthor === '1';
        }

        const showDescription = params.get('showDescription');
        if (showDescription !== null) {
          config.showDescription = showDescription === 'true' || showDescription === '1';
        }

        const showCaptions = params.get('showCaptions');
        if (showCaptions !== null) {
          config.showCaptions = showCaptions === 'true' || showCaptions === '1';
        }

        return config;
      }

      function notifyParent(event, data) {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: 'jaaq-player-event',
              event: event,
              data: data,
            },
            '*',
          );
        }
      }

      function initPlayer() {
        try {
          console.log('[Embed] Initializing player...');
          const config = getQueryParams();
          console.log('[Embed] Config:', config);
          const container = document.getElementById('player-container');

          const player = document.createElement('jaaq-video-player');
          console.log('[Embed] Created web component:', player);
          player.setAttribute('video-id', config.videoId);
          player.setAttribute('api-key', config.apiKey);
          player.setAttribute('client-id', config.clientId);

          if (config.baseUrl) {
            player.setAttribute('base-url', config.baseUrl);
          }

          if (config.autoplay) {
            player.setAttribute('autoplay', 'true');
          }

          player.setAttribute('width', config.width || '100%');
          player.setAttribute('height', config.height || '100%');

          if (config.controls !== undefined) {
            player.setAttribute('controls', config.controls ? 'true' : 'false');
          }

          if (config.showLogo !== undefined) {
            player.setAttribute('show-logo', config.showLogo ? 'true' : 'false');
          }

          if (config.showTitle !== undefined) {
            player.setAttribute('show-title', config.showTitle ? 'true' : 'false');
          }

          if (config.showAuthor !== undefined) {
            player.setAttribute('show-author', config.showAuthor ? 'true' : 'false');
          }

          if (config.showDescription !== undefined) {
            player.setAttribute('show-description', config.showDescription ? 'true' : 'false');
          }

          if (config.showCaptions !== undefined) {
            player.setAttribute('show-captions', config.showCaptions ? 'true' : 'false');
          }

          player.addEventListener('jaaq:loaded', (e) => {
            const video = e.detail;
            notifyParent('loaded', { id: video.id, title: video.title, question: video.question });
          });

          player.addEventListener('jaaq:play', () => {
            notifyParent('play', null);
          });

          player.addEventListener('jaaq:pause', () => {
            notifyParent('pause', null);
          });

          player.addEventListener('jaaq:timeupdate', (e) => {
            notifyParent('timeupdate', { currentTime: e.detail });
          });

          player.addEventListener('jaaq:volumechange', (e) => {
            notifyParent('volumechange', { volume: e.detail });
          });

          player.addEventListener('jaaq:ended', () => {
            notifyParent('ended', null);
          });

          player.addEventListener('jaaq:error', (e) => {
            console.error('[Embed] Player error event:', e.detail);
            showError(e.detail?.message || 'Unknown player error');
            notifyParent('error', { message: e.detail?.message || 'Unknown error' });
          });

          player.addEventListener('jaaq:fullscreenchange', (e) => {
            notifyParent('fullscreenchange', { isFullscreen: e.detail });
          });

          window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'jaaq-player-command') {
              const { command, args } = event.data;

              switch (command) {
                case 'play':
                  player.play();
                  break;
                case 'pause':
                  player.pause();
                  break;
                case 'toggleMute':
                  player.toggleMute();
                  break;
                case 'setVolume':
                  if (args && typeof args.volume === 'number') {
                    player.setVolume(args.volume);
                  }
                  break;
                case 'seek':
                  if (args && typeof args.time === 'number') {
                    player.seek(args.time);
                  }
                  break;
                case 'getState':
                  notifyParent('state', player.getState());
                  break;
              }
            }
          });

          container.appendChild(player);
          console.log('[Embed] Player appended to container');
          notifyParent('ready', null);
        } catch (error) {
          console.error('[Embed] Initialization error:', error);
          showError(error.message);
          notifyParent('error', { message: error.message });
        }
      }

      function waitForComponent() {
        if (customElements.get('jaaq-video-player')) {
          console.log('[Embed] Web component already registered');
          initPlayer();
        } else {
          console.log('[Embed] Waiting for web component registration...');

          if (typeof JaaqWebComponents !== 'undefined' && JaaqWebComponents.registerJaaqComponents) {
            console.log('[Embed] Manually registering components...');
            JaaqWebComponents.registerJaaqComponents();
            initPlayer();
          } else {
            customElements.whenDefined('jaaq-video-player').then(() => {
              console.log('[Embed] Web component registered');
              initPlayer();
            });
          }
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForComponent);
      } else {
        waitForComponent();
      }
    </script>

    <script
      src="__JAAQ_CDN_URL__/jaaq-webcomponents-bundled.min.js"
      onerror="console.error('[Embed] Failed to load web component script'); showError('Failed to load player script');"
      onload="console.log('[Embed] Web component script loaded');"
    ></script>
  </body>
</html>
