<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JAAQ Embed Player</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #000;
      }

      #player-container {
        width: 100%;
        height: 100%;
      }

      .error-container {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        background: #1a1a1a;
        color: #fff;
        padding: 20px;
      }

      .error-content {
        text-align: center;
        max-width: 400px;
      }

      .error-content h1 {
        font-size: 18px;
        margin-bottom: 12px;
        color: #ff6b6b;
      }

      .error-content p {
        font-size: 14px;
        color: #ccc;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div id="player-container"></div>

    <script src="../../dist/ui/jaaq-ui-bundled.min.js"></script>

    <script>
      function showError(message) {
        const container = document.getElementById('player-container');
        container.innerHTML = `
          <div class="error-container">
            <div class="error-content">
              <h1>⚠️ Player Error</h1>
              <p>${message}</p>
            </div>
          </div>
        `;
      }

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const config = {};

        const apiKey = params.get('apiKey');
        const clientId = params.get('clientId');
        const videoId = params.get('videoId');

        if (!apiKey || !clientId || !videoId) {
          const missing = [];
          if (!apiKey) missing.push('apiKey');
          if (!clientId) missing.push('clientId');
          if (!videoId) missing.push('videoId');
          throw new Error(`Missing required parameters: ${missing.join(', ')}`);
        }

        config.apiKey = apiKey;
        config.clientId = clientId;
        config.videoId = videoId;

        const autoplay = params.get('autoplay');
        if (autoplay !== null) {
          config.autoplay = autoplay === 'true' || autoplay === '1';
        }

        const width = params.get('width');
        if (width) {
          config.width = width;
        }

        const height = params.get('height');
        if (height) {
          config.height = height;
        }

        const baseUrl = params.get('baseUrl');
        if (baseUrl) {
          config.baseUrl = baseUrl;
        }

        return config;
      }

      function notifyParent(event, data) {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: 'jaaq-player-event',
              event: event,
              data: data,
            },
            '*',
          );
        }
      }

      try {
        const config = getQueryParams();
        const container = document.getElementById('player-container');

        const player = new JaaqUI.JaaqVideoPlayer(container, config);

        player.on('loaded', (video) => {
          notifyParent('loaded', { id: video.id, title: video.title, question: video.question });
        });

        player.on('play', () => {
          notifyParent('play', null);
        });

        player.on('pause', () => {
          notifyParent('pause', null);
        });

        player.on('timeupdate', (time) => {
          notifyParent('timeupdate', { currentTime: time });
        });

        player.on('volumechange', (volume) => {
          notifyParent('volumechange', { volume: volume });
        });

        player.on('ended', () => {
          notifyParent('ended', null);
        });

        player.on('error', (error) => {
          notifyParent('error', { message: error.message });
        });

        player.on('fullscreenchange', (isFullscreen) => {
          notifyParent('fullscreenchange', { isFullscreen: isFullscreen });
        });

        window.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'jaaq-player-command') {
            const { command, args } = event.data;

            switch (command) {
              case 'play':
                player.play();
                break;
              case 'pause':
                player.pause();
                break;
              case 'toggleMute':
                player.toggleMute();
                break;
              case 'setVolume':
                if (args && typeof args.volume === 'number') {
                  player.setVolume(args.volume);
                }
                break;
              case 'seek':
                if (args && typeof args.time === 'number') {
                  player.seek(args.time);
                }
                break;
              case 'getState':
                notifyParent('state', player.getState());
                break;
            }
          }
        });

        notifyParent('ready', null);
      } catch (error) {
        showError(error.message);
        notifyParent('error', { message: error.message });
      }
    </script>
  </body>
</html>
