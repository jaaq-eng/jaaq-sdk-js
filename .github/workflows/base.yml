name: Reusable CI Base

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      ref:
        required: false
        type: string
        default: ''

jobs:
  ci:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: write
    env:
      NODE_ENV: ${{ inputs.environment }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      JAAQ_API_URL: ${{ vars.JAAQ_API_URL }}
      JAAQ_CDN_URL: ${{ vars.JAAQ_CDN_URL }}
      S3_BUCKET: ${{ vars.S3_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      AWS_REGION: ${{ vars.AWS_REGION }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || github.ref }}

      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'pnpm'

      - name: Show versions and environment
        run: |
          node -v
          pnpm -v
          echo "NPM_TOKEN=${{ env.NPM_TOKEN }}"
          echo "ENVIRONMENT=${{ inputs.environment }}"
          echo "NODE_ENV=${{ env.NODE_ENV }}"
          echo "JAAQ_API_URL=${{ env.JAAQ_API_URL }}"
          echo "JAAQ_CDN_URL=${{ env.JAAQ_CDN_URL }}"
          echo "S3_BUCKET=${{ env.S3_BUCKET }}"
          echo "CLOUDFRONT_DISTRIBUTION_ID=${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "AWS_ROLE_ARN=${{ env.AWS_ROLE_ARN }}"
          echo "AWS_REGION=${{ env.AWS_REGION }}"

      - name: audit dependencies
        run: pnpm run audit:moderate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test

      - name: Run coverage tests
        run: pnpm run test:coverage

      - name: Build
        env:
          JAAQ_CDN_URL: ${{ vars.JAAQ_CDN_URL }}
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_HASH=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)

          export SHORT_HASH
          export BUILD_DATE=$DATE

          pnpm build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Upload files to S3
        env:
          S3_BUCKET: ${{ vars.S3_BUCKET }}
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_HASH=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)

          if [ "${{ inputs.environment }}" = "development" ]; then
            FULL_VERSION="$BASE_VERSION-dev-$SHORT_HASH-$DATE"
          elif [ "${{ inputs.environment }}" = "staging" ]; then
            FULL_VERSION="$BASE_VERSION-rc-$SHORT_HASH-$DATE"
          else
            FULL_VERSION="$BASE_VERSION"
          fi

          aws s3 cp dist/jaaq-sdk.min.js s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/jaaq-sdk.min.js
          aws s3 cp dist/jaaq-sdk.min.js s3://$S3_BUCKET/jaaq-sdk-js/latest/jaaq-sdk.min.js

          aws s3 cp dist/ui/jaaq-ui.min.js s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/jaaq-ui.min.js
          aws s3 cp dist/ui/jaaq-ui.min.js s3://$S3_BUCKET/jaaq-sdk-js/latest/jaaq-ui.min.js

          aws s3 cp dist/ui/jaaq-ui-bundled.min.js s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/jaaq-ui-bundled.min.js
          aws s3 cp dist/ui/jaaq-ui-bundled.min.js s3://$S3_BUCKET/jaaq-sdk-js/latest/jaaq-ui-bundled.min.js

          aws s3 cp dist/ui/webcomponents/jaaq-webcomponents.min.js s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/jaaq-webcomponents.min.js
          aws s3 cp dist/ui/webcomponents/jaaq-webcomponents.min.js s3://$S3_BUCKET/jaaq-sdk-js/latest/jaaq-webcomponents.min.js

          aws s3 cp dist/ui/webcomponents/jaaq-webcomponents-bundled.min.js s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/jaaq-webcomponents-bundled.min.js
          aws s3 cp dist/ui/webcomponents/jaaq-webcomponents-bundled.min.js s3://$S3_BUCKET/jaaq-sdk-js/latest/jaaq-webcomponents-bundled.min.js

          aws s3 cp dist/embed/embed.html s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/embed.html
          aws s3 cp dist/embed/embed.html s3://$S3_BUCKET/jaaq-sdk-js/latest/embed.html

          aws s3 cp dist/embed/embed-collection.html s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/embed-collection.html
          aws s3 cp dist/embed/embed-collection.html s3://$S3_BUCKET/jaaq-sdk-js/latest/embed-collection.html

          aws s3 cp dist/embed/embed.html s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/embed/embed.html
          aws s3 cp dist/embed/embed.html s3://$S3_BUCKET/jaaq-sdk-js/latest/embed/embed.html

          aws s3 cp dist/embed/embed-collection.html s3://$S3_BUCKET/jaaq-sdk-js/v$FULL_VERSION/embed/embed-collection.html
          aws s3 cp dist/embed/embed-collection.html s3://$S3_BUCKET/jaaq-sdk-js/latest/embed/embed-collection.html

      - name: Invalidate CloudFront cache
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/jaaq-sdk-js/latest/*" "/jaaq-sdk-js/v*"

      - name: Smoke tests
        run: pnpm run test:smoke:ci

      - name: Setup npm auth
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Compute version and publish
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_HASH=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)

          if [ "${{ inputs.environment }}" = "development" ]; then
            PUBLISH_VERSION="$BASE_VERSION-dev-$SHORT_HASH-$DATE"
            npm version $PUBLISH_VERSION --no-git-tag-version
            pnpm publish --tag dev --no-git-checks
          elif [ "${{ inputs.environment }}" = "staging" ]; then
            PUBLISH_VERSION="$BASE_VERSION-rc-$SHORT_HASH-$DATE"
            npm version $PUBLISH_VERSION --no-git-tag-version
            pnpm publish --tag rc --no-git-checks
          elif [ "${{ inputs.environment }}" = "production" ]; then
            pnpm publish --tag latest --no-git-checks
          fi

      - name: Create Git Tag for Production
        if: inputs.environment == 'production'
        run: |
          VERSION=$(node -p "require('./package.json').version")
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
