name: SDK CI (Base Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment: development | staging | production"
        required: true
        type: string
    secrets:
      # NPM_TOKEN:
      #   description: "NPM token for publishing (set when enabling publish)"
      #   required: false
      # NOTE: JAAQ_API_URL is read from GitHub Environment variables (vars), not from secrets.

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write # needed only if you later enable version bump pushing commits/tags

defaults:
  run:
    shell: bash

jobs:
  test-and-deploy:
    name: "SDK Pipeline – ${{ inputs.environment }}"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Attach the job to the GitHub Environment so protection rules & environment vars apply
    environment: ${{ inputs.environment }}

    env:
      NODE_ENV: ${{ inputs.environment }}
      # Read the API URL from GitHub Environment VARIABLES (not from secrets)
      JAAQ_API_URL: ${{ vars.JAAQ_API_URL }}
      CI: "true"

    steps:
      # --- Setup once ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Enable Corepack (pnpm)
        run: corepack enable

      - name: Print Node & pnpm versions
        run: |
          node -v
          pnpm -v

      # --- Echo environment & dotenv ---
      - name: Echo selected environment (input)
        run: echo "Selected environment input = ${{ inputs.environment }}"

      # Load dotenv (.env.<environment>) but DO NOT override CI-provided env
      - name: Load dotenv (.env.<environment>) if present (no override)
        id: dotenv
        run: |
          set -euo pipefail
          ENV_FILE=".env.${{ inputs.environment }}"
          echo "DOTENV_FILE=$ENV_FILE" >> "$GITHUB_ENV"
          if [ -f "$ENV_FILE" ]; then
            echo "Found $ENV_FILE. Loading variables into job environment (without overriding existing) ..."
            while IFS= read -r line; do
              # skip comments and empty lines
              if [[ -z "$line" || "$line" =~ ^# ]]; then
                continue
              fi
              key="${line%%=*}"
              val="${line#*=}"
              # strip quotes
              val="${val%\"}"; val="${val#\"}"
              val="${val%\'}"; val="${val#\'}"
              # only export if not already set in the environment (CI vars take precedence)
              if [ -z "${!key:-}" ]; then
                echo "${key}=${val}" >> "$GITHUB_ENV"
              fi
            done < "$ENV_FILE"
          else
            echo "No $ENV_FILE file found. Skipping dotenv load."
          fi

      - name: Echo effective environment (from CI vars + optional dotenv)
        run: |
          echo "DOTENV_FILE = ${DOTENV_FILE:-<none>}"
          echo "NODE_ENV (effective) = ${NODE_ENV:-<not set>}"
          if [ -n "${JAAQ_API_URL:-}" ]; then
            echo "JAAQ_API_URL is set to: ${JAAQ_API_URL}"
          else
            echo "JAAQ_API_URL is NOT set"
          fi

      # Enforce JAAQ_API_URL presence for dev & staging (for prod it's optional to allow fallback)
      - name: Ensure JAAQ_API_URL set (dev/staging only)
        if: ${{ inputs.environment == 'development' || inputs.environment == 'staging' }}
        run: |
          set -euo pipefail
          if [ -z "${JAAQ_API_URL:-}" ]; then
            echo "JAAQ_API_URL is required for development/staging. Set it as a GitHub Environment variable." >&2
            exit 1
          fi

      # --- Install once ---
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # --- Tests ---
      - name: Run unit tests
        run: pnpm test

      # --- Build ---
      - name: Build package
        run: pnpm build

      # --- Smoke tests ---
      - name: Run smoke tests
        env:
          NODE_ENV: ${{ inputs.environment }}
          JAAQ_API_URL: ${{ vars.JAAQ_API_URL }}
        run: |
          echo "Running smoke tests with NODE_ENV=${NODE_ENV} and JAAQ_API_URL=${JAAQ_API_URL:-<prod fallback>}"
          pnpm test:smoke

      # --- What would be published ---
      - name: What would be published?
        run: |
          case "${{ inputs.environment }}" in
            development)
              echo "➡️ Would publish to NPM with dist-tag: @dev (e.g., npm publish --tag dev)"
              ;;
            staging)
              echo "➡️ Would publish to NPM with dist-tag: @next (e.g., npm publish --tag next)"
              ;;
            production)
              echo "➡️ Would publish to NPM as the default (latest) tag"
              ;;
            *)
              echo "Unknown environment: '${{ inputs.environment }}'"
              exit 1
              ;;
          esac

      # --- Version bump (DISABLED) ---
      # Choose ONE approach: Changesets (recommended) OR npm version.
      # Enable when ready; requires 'permissions: contents: write'.
      #
      # - name: Version bump via Changesets (disabled)
      #   if: ${{ inputs.environment == 'production' }} # or 'staging'/'development' per your policy
      #   run: |
      #     set -euo pipefail
      #     pnpm changeset version   # applies .changeset/* and updates CHANGELOG.md
      #     pnpm install             # update lockfile after version bump
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git add -A
      #     git commit -m "chore: version bump & changelog [skip ci]" || echo "No version changes to commit."
      #     git push --follow-tags
      #
      # - name: Version bump via npm (SemVer) – disabled
      #   if: ${{ inputs.environment == 'production' }}
      #   run: |
      #     set -euo pipefail
      #     # Choose one: patch | minor | major | prerelease --preid dev|next
      #     npm version patch -m "chore: release v%s [skip ci]"
      #     git push --follow-tags

      # --- Publish to NPM (DISABLED until NPM_TOKEN is configured) ---
      # - name: Publish to NPM (disabled)
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: |
      #     set -euo pipefail
      #     case "${{ inputs.environment }}" in
      #       development)
      #         npm publish --tag dev --access public
      #         ;;
      #       staging)
      #         npm publish --tag next --access public
      #         ;;
      #       production)
      #         npm publish --access public
      #         ;;
      #       *)
      #         echo "Unknown environment: '${{ inputs.environment }}'"
      #         exit 1
      #         ;;
      #     esac
